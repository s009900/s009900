name: Process Word Cloud Submission

on:
  issues:
    types: [opened, edited, labeled]
  workflow_dispatch:

# Set the permissions at the workflow level
permissions:
  contents: write  # For committing changes
  issues: write    # For adding comments and closing issues
  pull-requests: write  # For creating pull requests if needed

jobs:
  process-word:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Fetch all history for all branches and tags
        persist-credentials: true  # This ensures the token persists for pushing
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r .github/wordcloud/requirements.txt
        
        # Create assets directory with proper permissions
        mkdir -p assets
        chmod -R 777 assets
    
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        git config --global --add safe.directory /github/workspace
        # Fetch the latest changes from the main branch
        git fetch origin main
        git checkout main
        # Reset to ensure we're up to date
        git reset --hard origin/main

    - name: Process new word
      id: process
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -e  # Exit immediately if a command exits with a non-zero status
        
        echo "Starting word cloud processing..."
        
        # Check if we have an issue body
        if [ -z "${{ github.event.issue.body }}" ]; then
          echo "Error: No issue body found"
          echo "result=âŒ Error: No issue body found" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # Create assets directory if it doesn't exist
        mkdir -p assets
        
        # Pass the issue body to our Python script
        if ! python .github/wordcloud/process_issue.py "${{ github.event.issue.body }}"; then
          echo "Error: Failed to process the word"
          echo "result=âŒ Error: Failed to process the word" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "Word processed successfully, generating word cloud..."
        
        # Generate the word cloud with full debug output
        echo "Current directory: $(pwd)"
        echo "Files in .github/wordcloud/: $(ls -la .github/wordcloud/)"
        echo "Contents of words.json: $(cat .github/wordcloud/words.json)"
        
        if ! python .github/wordcloud/generate_wordcloud.py; then
          echo "Error: Failed to generate word cloud"
          echo "result=âŒ Error: Failed to generate word cloud" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # Verify the word cloud was generated
        if [ ! -f "assets/wordcloud.png" ]; then
          echo "Error: Word cloud image not found after generation"
          echo "result=âŒ Error: Word cloud image not generated" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "Word cloud generated successfully"
        
        # Configure git
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        
        # Add and commit changes
        git add .github/wordcloud/words.json
        git add assets/wordcloud.png
        
        # Verify what's being committed
        echo "Files to be committed:"
        git status --porcelain
        
        # Only commit if there are changes
        if ! git diff --quiet --staged; then
          echo "Committing changes..."
          git commit -m "chore: update word cloud"
          
          # Set up authentication for push
          git remote set-url origin https://x-access-token:$GITHUB_TOKEN@github.com/${{ github.repository }}.git
          
          # Pull any changes first to avoid conflicts
          git pull --rebase origin main
          
          # Push changes with token authentication
          if ! git push https://x-access-token:$GITHUB_TOKEN@github.com/${{ github.repository }}.git HEAD:main; then
            echo "âŒ Failed to push changes"
            echo "result=âŒ Error: Failed to push changes" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "âœ… Changes pushed successfully"
          echo "result=âœ… Word cloud updated successfully! ðŸŽ‰" >> $GITHUB_OUTPUT
        else
          echo "No changes to commit"
          echo "result=â„¹ï¸ No changes to commit" >> $GITHUB_OUTPUT
        fi
    
    - name: Close the issue
      if: always()  # Run this step even if previous steps fail
      uses: actions/github-script@v6
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        script: |
          try {
            const result = '${{ steps.process.outputs.result }}';
            console.log('Step output:', result);
            
            // Get the issue number from the event
            const issueNumber = context.issue ? context.issue.number : null;
            if (!issueNumber) {
              console.log('No issue number found in context');
              return;
            }
            
            console.log(`Processing issue #${issueNumber}`);
            
            // Add a comment with the result
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: result || 'Word cloud processing completed.'
            });
            
            // Close the issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed',
              state_reason: 'completed'
            });
            
            console.log('Successfully closed the issue');
          } catch (error) {
            console.error('Error in GitHub Script:', error);
            // Fail the step if there's an error
            core.setFailed(`Action failed with error: ${error}`);
          }
