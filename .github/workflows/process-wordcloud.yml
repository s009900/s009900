name: Process Word Cloud Submission

on:
  issues:
    types: [opened, edited, labeled]
  workflow_dispatch:

# Set the permissions at the workflow level
permissions:
  contents: write  # For committing changes
  issues: write    # For adding comments and closing issues
  pull-requests: write  # For creating pull requests if needed

jobs:
  process-word:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r .github/wordcloud/requirements.txt
    
    - name: Process new word
      id: process
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -e  # Exit immediately if a command exits with a non-zero status
        
        echo "Starting word cloud processing..."
        echo "Current directory: $(pwd)"
        echo "Repository contents:"
        ls -la
        
        # Check if we have an issue body
        if [ -z "${{ github.event.issue.body }}" ]; then
          echo "Error: No issue body found"
          echo "result=❌ Error: No issue body found" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # Create assets directory if it doesn't exist
        mkdir -p assets
        
        # Pass the issue body to our Python script
        echo "Processing word from issue..."
        if ! python .github/wordcloud/process_issue.py "${{ github.event.issue.body }}"; then
          echo "Error: Failed to process the word"
          echo "result=❌ Error: Failed to process the word" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "Word processed successfully, generating word cloud..."
        
        # Generate the word cloud
        echo "Generating word cloud..."
        if ! python .github/wordcloud/generate_wordcloud.py; then
          echo "Error: Failed to generate word cloud"
          echo "result=❌ Error: Failed to generate word cloud" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # Verify word cloud was created
        if [ ! -f "assets/wordcloud.png" ]; then
          echo "Error: Word cloud image was not generated"
          echo "result=❌ Error: Word cloud image was not generated" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "Word cloud generated successfully!"
        
        # Configure git
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        
        # Add and commit changes
        git add .github/wordcloud/words.json assets/wordcloud.png
        
        # Only commit if there are changes
        if ! git diff --quiet --staged; then
          echo "Committing changes..."
          git commit -m "chore: update word cloud"
          
          # Set up authentication for push
          git remote set-url origin https://x-access-token:$GITHUB_TOKEN@github.com/${{ github.repository }}.git
          
          # Push changes
          if git push; then
            echo "✅ Changes pushed successfully"
            echo "result=✅ Word cloud updated successfully! 🎉" >> $GITHUB_OUTPUT
          else
            echo "❌ Failed to push changes"
            echo "result=❌ Error: Failed to push changes" >> $GITHUB_OUTPUT
            exit 1
          fi
        else
          echo "No changes to commit"
          echo "result=ℹ️ No changes to commit" >> $GITHUB_OUTPUT
        fi
    
    - name: Close the issue
      if: always()  # Run this step even if previous steps fail
      uses: actions/github-script@v6
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        script: |
          try {
            const result = '${{ steps.process.outputs.result }}';
            console.log('Step output:', result);
            
            // Get the issue number from the event
            const issueNumber = context.issue ? context.issue.number : null;
            if (!issueNumber) {
              console.log('No issue number found in context');
              return;
            }
            
            console.log(`Processing issue #${issueNumber}`);
            
            // Add a comment with the result
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: result || 'Word cloud processing completed.'
            });
            
            // Close the issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed',
              state_reason: 'completed'
            });
            
            console.log('Successfully closed the issue');
          } catch (error) {
            console.error('Error in GitHub Script:', error);
            // Fail the step if there's an error
            core.setFailed(`Action failed with error: ${error}`);
          }
