name: Update Guestbook in README

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'  # Runs every hour
  issues:
    types: [closed]

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Get Guestbook Entries
        id: guestbook
        uses: actions/github-script@v6
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'guestbook',
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 10
            });
            
            // Create table header
            let tableContent = '| Name | Message | Date |\n|------|---------|------|\n';
            
            // Process each guestbook entry
            for (const issue of issues) {
              if (issue.comments > 0) {
                const comments = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number
                });
                
                if (comments.data.length > 0) {
                  const comment = comments.data[0].body;
                  // Extract the table row from the comment
                  const tableMatch = comment.match(/\|\s*\*\*.*?\*\*\s*\|.*?\|.*?\|/);
                  if (tableMatch) {
                    const date = new Date(issue.updated_at).toISOString().split('T')[0];
                    tableContent += `${tableMatch[0]}\n`;
                  }
                }
              }
            }
            
            // If no entries, return a message
            if (tableContent === '| Name | Message | Date |\n|------|---------|------|\n') {
              return 'No entries yet. Be the first!';
            }
            
            return tableContent;

      - name: Update README
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const readme = fs.readFileSync('README.md', 'utf8');
            const newReadme = readme.replace(
              /<!-- GUESTBOOK:START -->[\s\S]*?<!-- GUESTBOOK:END -->/,
              `<!-- GUESTBOOK:START -->\n${steps.guestbook.outputs.result || 'No entries yet. Be the first!'}\n<!-- GUESTBOOK:END -->`
            );
            
            if (readme !== newReadme) {
              const { data: fileData } = await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: 'README.md',
                ref: 'main'  // or 'master' depending on your default branch
              });
              
              await github.rest.repos.createOrUpdateFileContents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: 'README.md',
                message: 'docs: update guestbook entries',
                content: Buffer.from(newReadme).toString('base64'),
                sha: fileData.sha,
                branch: 'main'  // or 'master' depending on your default branch
              });
            }
