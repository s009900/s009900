name: Update Followers List

on:
  schedule:
    # Runs every 30 minutes
    - cron: '*/30 * * * *'
  workflow_dispatch:  # Allows manual triggering

jobs:
  update-followers:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Update Followers List
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { execSync } = require('child_process');
            const fs = require('fs');
            
            try {
              console.log('Fetching latest followers...');
              // Get the 4 most recent followers
              const { data: followers } = await github.rest.users.listFollowersForUser({
                username: 's009900',
                per_page: 4,
                headers: {
                  'X-GitHub-Api-Version': '2022-11-28'
                }
              });
              
              console.log(`Found ${followers.length} followers`);
              
              // Generate the followers table
              let followersTable = '| # | Avatar | Username |\n|--:|:------:|:---------|\n';
              
              followers.forEach((follower, index) => {
                followersTable += `| ${index + 1} | <img src="${follower.avatar_url}" width="50" height="50" alt="${follower.login}" /> | [@${follower.login}](${follower.html_url}) |\n`;
              });
              
              console.log('Generated followers table:');
              console.log(followersTable);
              
              // Update the README.md directly
              const readmePath = 'README.md';
              const readmeContent = fs.readFileSync(readmePath, 'utf8');
              const timestamp = new Date().toLocaleString();
              
              // Create the followers section
              const followersSection = [
                '### ü§ù Community',
                '- [How to Contribute](additional-readmes/contributions.readme.md)',
                '- [Our Amazing Contributors](additional-readmes/contributors.readme.md)',
                '- [Recent Followers](additional-readmes/followers.readme.md)',
                '',
                '#### üë• Recent Followers',
                `*Last updated: ${timestamp}*`, 
                '',
                followersTable,
                '',
                '> Note: This list shows your 4 most recent followers and updates every 30 minutes.',
                ''
              ].join('\n');
              
              // Replace the existing community section
              const updatedReadme = readmeContent.replace(
                /### ü§ù Community[\s\S]*?(?=### |<\/details>|$)/,
                followersSection
              );
              
              // Write back to README.md
              fs.writeFileSync(readmePath, updatedReadme);
              console.log('Successfully updated README with followers');
              
              // Also update the followers.readme.md file for reference
              const followersPath = 'additional-readmes/followers.readme.md';
              const followersContent = [
                '# üë• Recent Followers',
                '',
                `Last updated: ${timestamp}`,
                '',
                followersTable,
                '',
                '> Note: This list shows your 4 most recent followers and updates every 30 minutes.'
              ].join('\n');
              
              fs.writeFileSync(followersPath, followersContent);
              
              // Commit and push changes if there are any
              try {
                // Configure git
                execSync('git config --global user.name "GitHub Action"');
                execSync('git config --global user.email "action@github.com"');
                
                // Add the changed files
                execSync('git add README.md additional-readmes/followers.readme.md');
                
                // Check if there are changes to commit
                const status = execSync('git status --porcelain').toString();
                if (status) {
                  execSync('git commit -m \"Update followers list\"');
                  execSync('git push');
                  console.log('Successfully committed and pushed changes');
                } else {
                  console.log('No changes to commit');
                }
              } catch (error) {
                console.error('Error committing changes:', error);
                core.setFailed(`Failed to commit changes: ${error.message}`);
              }
              
            } catch (error) {
              console.error('Action failed with error:', error);
              core.setFailed(error.message);
            }
