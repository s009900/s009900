name: Update Followers List

on:
  schedule:
    # Runs every 30 minutes
    - cron: '*/30 * * * *'
  workflow_dispatch:  # Allows manual triggering

jobs:
  update-followers:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Update Followers List
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { execSync } = require('child_process');
            const fs = require('fs');
            
            try {
              console.log('Fetching latest followers...');
              // Get the 4 most recent followers
              const { data: followers } = await github.rest.users.listFollowersForUser({
                username: 's009900',
                per_page: 4,
                headers: {
                  'X-GitHub-Api-Version': '2022-11-28'
                }
              });
              
              console.log(`Found ${followers.length} followers`);
              
              // Generate the followers table
              let followersTable = '| # | Avatar | Username |\n|--:|:------:|:---------|\n';
              
              followers.forEach((follower, index) => {
                followersTable += `| ${index + 1} | <img src="${follower.avatar_url}" width="50" height="50" alt="${follower.login}" /> | [@${follower.login}](${follower.html_url}) |\n`;
              });
              
              console.log('Generated followers table:');
              console.log(followersTable);
              
              // Update the followers.readme.md file
              const followersPath = 'additional-readmes/followers.readme.md';
              const timestamp = new Date().toLocaleString();
              
              const followersContent = [
                '# ðŸ‘¥ Recent Followers',
                '',
                `Last updated: ${timestamp}`,
                '',
                '| # | Avatar | Username |',
                '|--:|:------:|:---------|',
                followersTable,
                '',
              ].join('\n');
              
              fs.writeFileSync(followersPath, followersContent);
              console.log('Successfully updated followers list');
              
              // Commit and push changes if there are any
              try {
                // Configure git
                execSync('git config --global user.name "GitHub Action"');
                execSync('git config --global user.email "action@github.com"');
                
                // Add the changed files
                execSync('git add additional-readmes/followers.readme.md');
                
                // Configure git to use the GitHub token for authentication
                const remoteRepo = `https://${process.env.GITHUB_ACTOR}:${{ secrets.GITHUB_TOKEN }}@github.com/${process.env.GITHUB_REPOSITORY}.git`;
                
                // Commit the changes
                execSync('git commit -m "Update followers list" || echo "No changes to commit"');
                
                // Push the changes
                execSync(`git push ${remoteRepo} HEAD:${process.env.GITHUB_REF} --force`);
                console.log('Successfully committed and pushed changes');
              } catch (error) {
                console.error('Error committing changes:', error);
                core.setFailed(`Failed to commit changes: ${error.message}`);
              }
              
            } catch (error) {
              console.error('Action failed with error:', error);
              core.setFailed(error.message);
            }
