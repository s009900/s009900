name: Update Followers List

on:
  schedule:
    # Runs daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-followers:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Followers
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: followers } = await github.rest.users.listFollowersForUser({
              username: 's009900',
              per_page: 4,
              headers: {'X-GitHub-Api-Version': '2022-11-28'}
            });

            let tableContent = `| # | Avatar | Username |\n|--:|:------:|:---------|\n`;
            followers.forEach((follower, index) => {
              tableContent += `| ${index+1} | <img src="${follower.avatar_url}" width="50" height="50" /> | [@${follower.login}](${follower.html_url}) |\n`;
            });

            const content = [
              '<!-- START FOLLOWERS -->',
              '<!-- DO NOT EDIT THIS SECTION - Generated by GitHub Actions -->',
              '## ðŸ‘¥ Recent Followers',
              `_Last updated: ${new Date().toUTCString()}_`,
              '',
              tableContent,
              '_âœ¨ Updated daily via GitHub Actions_',
              '<!-- END FOLLOWERS -->'
            ].join('\n');

            // Read the current README
            const fs = require('fs');
            let readmeContent = fs.readFileSync('README.md', 'utf8');
            
            // Replace the followers section
            const startMarker = '<!-- START FOLLOWERS -->';
            const endMarker = '<!-- END FOLLOWERS -->';
            
            const startIndex = readmeContent.indexOf(startMarker);
            const endIndex = readmeContent.indexOf(endMarker) + endMarker.length;
            
            if (startIndex !== -1 && endIndex !== -1) {
              const beforeSection = readmeContent.substring(0, startIndex);
              const afterSection = readmeContent.substring(endIndex);
              readmeContent = beforeSection + content + afterSection;
              
              // Write the updated README
              fs.writeFileSync('README.md', readmeContent);
              console.log('Successfully updated README with followers');
            } else {
              console.error('Could not find followers markers in README');
              core.setFailed('Markers not found in README');
            }

      - name: Commit & Push
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "Update followers list in README" || echo "No changes to commit"
          git push