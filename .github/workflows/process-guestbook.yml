name: Process Guestbook Entry

on:
  issues:
    types: [opened, edited]

jobs:
  process-guestbook:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Process Guestbook Entry
        uses: actions/github-script@v6
        with:
          script: |
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            if (issue.state === 'closed') return;
            
            // Parse the issue body which is in YAML format
            const bodyLines = issue.body.split('\n');
            let message = '';
            let name = '';
            let currentField = '';
            
            for (let i = 0; i < bodyLines.length; i++) {
              const line = bodyLines[i].trim();
              if (line.startsWith('### ')) {
                if (line.includes('Your Message')) {
                  currentField = 'message';
                } else if (line.includes('Your Name')) {
                  currentField = 'name';
                } else {
                  currentField = '';
                }
              } else if (line.startsWith('```') || line === '') {
                // Skip code block markers and empty lines
                continue;
              } else if (currentField === 'message' && !line.startsWith('<!--')) {
                message = line.trim();
                currentField = '';
              } else if (currentField === 'name' && !line.startsWith('<!--')) {
                name = line.trim();
                currentField = '';
              }
            }
            
            // Create a comment with the full table structure for better parsing
            const formattedDate = new Date().toISOString().split('T')[0];
            const commentContent = '### Guestbook Entry\n\n' +
              '| Name | Message | Date |\n' +
              '|------|---------|------|\n' +
              `| **${name}** | ${message} | ${formattedDate} |`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: tableRow
            });
            
            // Close the issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });
