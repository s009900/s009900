name: Process Guestbook Entry

on:
  issues:
    types: [opened, edited]

jobs:
  process-guestbook:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Process Guestbook Entry
        uses: actions/github-script@v6
        with:
          script: |
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            if (issue.state === 'closed') return;
            
            // Parse the issue body which is in YAML format
            const bodyLines = issue.body.split('\n');
            let message = '';
            let name = '';
            
            for (let i = 0; i < bodyLines.length; i++) {
              const line = bodyLines[i].trim();
              if (line.startsWith('### Your Message')) {
                // The message is in the next line
                message = bodyLines[i + 1].trim();
              } else if (line.startsWith('### Your Name')) {
                // The name is in the next line
                name = bodyLines[i + 1].trim();
              }
            }
            
            // Create a simple comment with just the table row
            const formattedDate = new Date().toISOString().split('T')[0];
            const tableRow = `| **${name}** | ${message} | ${formattedDate} |`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: tableRow
            });
            
            // Close the issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });
