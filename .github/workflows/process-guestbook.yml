name: Process Guestbook Entry

on:
  issues:
    types: [opened, edited]

jobs:
  process-guestbook:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Process Guestbook Entry
        uses: actions/github-script@v6
        with:
          script: |
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            if (issue.state === 'closed') return;
            
            // Get the message and name from the issue body
            const message = issue.body.match(/### Your Message\s*([\s\S]*?)\s*### Your Name/)[1].trim();
            const name = issue.body.match(/### Your Name\s*([\s\S]*?)(?:\s*###|$)/)[1].trim();
            
            // Create a comment with the formatted entry as a table row
            const formattedDate = new Date().toISOString().split('T')[0];
            const tableRow = `| **${name}** | ${message} | ${formattedDate} |`;
            const tableHeader = '| Name | Message | Date |\n|------|---------|------|\n';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸ“ Guestbook Entry\n\n${tableHeader}${tableRow}\n\n_Thank you for signing the guestbook! ğŸ‰_`
            });
            
            // Close the issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });
